name: "Manual Terraform Deploy (Artifacts at GitHub cache)"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose action: apply or destroy"
        required: true
        type: choice
        options:
          - apply
          - destroy

concurrency:
  group: "terraform-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore terraform state (artifact)
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-${{ github.ref_name }}
          path: ./state-artifact
        continue-on-error: true

      - name: Move state if exists
        run: |
          if [ -f "./state-artifact/terraform.tfstate" ]; then
            mkdir -p terraform
            mv ./state-artifact/terraform.tfstate terraform/terraform.tfstate
            echo "State restored"
          else
            echo "No previous state found"
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply or Destroy
        working-directory: terraform
        env:
          YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }}
          YC_CLOUD_ID: ${{ secrets.YC_CLOUD_ID }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_PUBLIC_KEY: ${{ secrets.YC_PUBLIC_KEY }}
        run: |
          echo "Action: ${{ github.event.inputs.action }}"

          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            echo "Running DESTROY..."
            terraform destroy -auto-approve \
              -var="yc_oauth_token=${YC_OAUTH_TOKEN}" \
              -var="yc_cloud_id=${YC_CLOUD_ID}" \
              -var="yc_folder_id=${YC_FOLDER_ID}" \
              -var="yc_public_key=${YC_PUBLIC_KEY}"
          else
            echo "Running APPLY..."
            terraform apply -auto-approve \
              -var="yc_oauth_token=${YC_OAUTH_TOKEN}" \
              -var="yc_cloud_id=${YC_CLOUD_ID}" \
              -var="yc_folder_id=${YC_FOLDER_ID}" \
              -var="yc_public_key=${YC_PUBLIC_KEY}"

      - name: Upload terraform state (artifact)
        if: ${{ github.event.inputs.action == 'apply' }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ github.ref_name }}
          path: terraform/terraform.tfstate
